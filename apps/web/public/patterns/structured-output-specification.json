{
  "title": "Structured Output Specification",
  "status": "established",
  "authors": [
    "Nikola Balic (@nibzard)"
  ],
  "based_on": [
    "Vercel AI Team"
  ],
  "category": "Reliability & Eval",
  "source": "https://vercel.com/blog/what-we-learned-building-agents-at-vercel",
  "tags": [
    "structured-output",
    "schema",
    "validation",
    "reliability",
    "type-safety",
    "integration"
  ],
  "id": "structured-output-specification",
  "slug": "structured-output-specification",
  "updated_at": "2026-01-05",
  "body": "\n## Problem\n\nFree-form agent outputs are difficult to validate, parse, and integrate with downstream systems. When agents return unstructured text, you face:\n\n- Unpredictable output formats requiring complex parsing\n- Difficult validation and error handling\n- Brittle integration with automated workflows\n- Inconsistent categorization and classification\n- Manual post-processing to extract structured data\n\nThis makes it nearly impossible to build reliable multi-step workflows where one agent's output feeds into another system or agent.\n\n## Solution\n\nConstrain agent outputs using deterministic schemas that enforce structured, machine-readable results. Instead of allowing free-form text responses, specify exact output formats using type systems, JSON schemas, or framework-specific structured output APIs.\n\n**Core approach:**\n\n**Define explicit output schemas:**\n\n- Use TypeScript interfaces, JSON Schema, or Pydantic models\n- Specify required fields, types, and constraints\n- Define enumerations for categorical outputs\n- Document field semantics and validation rules\n\n**Leverage framework structured output APIs:**\n\n- OpenAI's structured outputs with JSON schema\n- Anthropic's tool use for structured results\n- Vercel AI SDK's `generateObject` function\n- LangChain's output parsers\n\n**Validate at generation time:**\n\n- Framework ensures LLM adheres to schema\n- Type errors caught before reaching application code\n- Guaranteed parseable outputs\n\n**Example implementation:**\n\n```typescript\nimport { generateObject } from 'ai';\nimport { z } from 'zod';\n\n// Define strict output schema\nconst LeadQualificationSchema = z.object({\n  qualification: z.enum(['qualified', 'unqualified', 'needs_review']),\n  confidence: z.number().min(0).max(1),\n  companySize: z.enum(['enterprise', 'mid-market', 'smb', 'unknown']),\n  estimatedBudget: z.string().optional(),\n  nextSteps: z.array(z.string()),\n  reasoning: z.string()\n});\n\n// Agent returns structured, validated output\nconst result = await generateObject({\n  model: openai('gpt-4'),\n  schema: LeadQualificationSchema,\n  prompt: `Analyze this lead: ${leadData}`\n});\n\n// TypeScript knows exact structure\nif (result.object.qualification === 'qualified') {\n  await sendToSalesTeam(result.object);\n}\n```\n\n**Integration benefits:**\n\n```mermaid\ngraph LR\n    A[Agent Input] --> B[LLM + Schema]\n    B --> C[Validated Structured Output]\n    C --> D[Downstream System]\n    C --> E[Database Storage]\n    C --> F[Next Agent Phase]\n\n    style C fill:#90EE90\n```\n\n## How to use it\n\n**When to apply:**\n\n- Multi-phase agent workflows requiring structured handoffs\n- Classification and categorization tasks\n- Data extraction and transformation\n- Integration with databases or APIs\n- Compliance and audit requirements\n- Quality assurance and validation\n\n**Implementation steps:**\n\n**1. Identify output requirements:**\n\n- What decisions does the agent make?\n- What data must be extracted?\n- What downstream systems consume this output?\n\n**2. Design schema:**\n\n```python\nfrom pydantic import BaseModel, Field\nfrom typing import Literal\n\nclass AbuseAnalysis(BaseModel):\n    content_type: Literal['spam', 'abuse', 'legitimate', 'unclear']\n    severity: Literal['critical', 'high', 'medium', 'low']\n    recommended_action: Literal['remove', 'warn', 'ignore', 'escalate']\n    confidence_score: float = Field(ge=0, le=1)\n    evidence: list[str]\n    requires_human_review: bool\n```\n\n**3. Integrate with agent framework:**\n\n```python\nresult = client.generate(\n    model=\"gpt-4\",\n    response_format=AbuseAnalysis,\n    messages=[{\"role\": \"user\", \"content\": abuse_report}]\n)\n\n# result is guaranteed to match schema\nif result.requires_human_review:\n    await send_to_human(result)\nelse:\n    await auto_execute(result.recommended_action)\n```\n\n**4. Handle validation failures:**\n\n- Retry with clarified prompt\n- Fallback to human review\n- Log schema violations for prompt improvement\n\n**Prerequisites:**\n\n- Agent framework with structured output support\n- Clear understanding of downstream data requirements\n- Schema validation library (Zod, Pydantic, JSON Schema)\n\n## Trade-offs\n\n**Pros:**\n\n- **Reliability:** Guaranteed parseable outputs eliminate parsing errors\n- **Type safety:** Compile-time checking in typed languages\n- **Integration:** Seamless connection to databases, APIs, workflows\n- **Validation:** Built-in constraint enforcement\n- **Maintainability:** Explicit contracts between system components\n- **Testability:** Easy to verify output correctness\n\n**Cons:**\n\n- **Rigidity:** Schema changes require coordinated updates\n- **Complexity:** Requires upfront schema design effort\n- **Expressiveness limits:** May constrain useful free-form outputs\n- **Framework dependency:** Relies on LLM provider schema support\n- **Over-specification:** Too strict schemas may cause generation failures\n- **Evolution friction:** Adapting schemas as requirements change\n\n**Mitigation strategies:**\n\n- Include optional `additional_context` field for free-form notes\n- Version schemas and support graceful degradation\n- Use union types for evolving classifications\n- Balance structure with flexibility (required vs optional fields)\n\n## References\n\n- [Vercel: What We Learned Building Agents](https://vercel.com/blog/what-we-learned-building-agents-at-vercel) - Lead qualification using structured categorization\n- [OpenAI Structured Outputs](https://platform.openai.com/docs/guides/structured-outputs) - JSON schema enforcement\n- [Vercel AI SDK generateObject](https://sdk.vercel.ai/docs/reference/ai-sdk-core/generate-object) - TypeScript-native structured generation\n- [Anthropic Tool Use](https://docs.anthropic.com/claude/docs/tool-use) - Structured outputs via tool calling\n- Related patterns: [Discrete Phase Separation](discrete-phase-separation.md), [Human-in-the-Loop Approval Framework](human-in-loop-approval-framework.md)\n"
}