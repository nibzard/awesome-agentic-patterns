---
import BaseLayout from '../../layouts/BaseLayout.astro';
import SearchBox from '../../components/SearchBox.astro';
import PatternCard from '../../components/PatternCard.astro';
import { getAllPatterns } from '../../lib/patterns';
import type {
  PatternEntry,
  CategoryCount,
  StatusCount,
  MaturityCount,
  ComplexityCount,
} from '../../types';

// Load patterns data
const patterns = (await getAllPatterns()) as PatternEntry[];

// Get unique values for filters with counts
const categoryMap = patterns.reduce((acc: Record<string, number>, p: PatternEntry) => {
  acc[p.category] = (acc[p.category] || 0) + 1;
  return acc;
}, {});

const categories = Object.entries(categoryMap)
  .map(([category, count]) => ({ category, count }))
  .sort((a, b) => b.count - a.count) as CategoryCount[];

const statusMap = patterns.reduce((acc: Record<string, number>, p: PatternEntry) => {
  acc[p.status] = (acc[p.status] || 0) + 1;
  return acc;
}, {});

const statuses = Object.entries(statusMap)
  .map(([status, count]) => ({ status, count }))
  .sort((a, b) => b.count - a.count) as StatusCount[];

const maturityMap = patterns.reduce((acc: Record<string, number>, p: PatternEntry) => {
  if (p.maturity) {
    acc[p.maturity] = (acc[p.maturity] || 0) + 1;
  }
  return acc;
}, {});

const maturities = Object.entries(maturityMap)
  .map(([maturity, count]) => ({ maturity, count }))
  .sort((a, b) => b.count - a.count) as MaturityCount[];

const complexityMap = patterns.reduce((acc: Record<string, number>, p: PatternEntry) => {
  if (p.complexity) {
    acc[p.complexity] = (acc[p.complexity] || 0) + 1;
  }
  return acc;
}, {});

const complexities = Object.entries(complexityMap)
  .map(([complexity, count]) => ({ complexity, count }))
  .sort((a, b) => b.count - a.count) as ComplexityCount[];

const tagMap = patterns.reduce((acc: Record<string, number>, p: PatternEntry) => {
  p.tags.forEach((tag) => {
    acc[tag] = (acc[tag] || 0) + 1;
  });
  return acc;
}, {});

const tags = Object.entries(tagMap)
  .map(([tag, count]) => ({ tag, count }))
  .sort((a, b) => b.count - a.count)
  .slice(0, 20);

const domainMap = patterns.reduce((acc: Record<string, number>, p: PatternEntry) => {
  (p.domains || []).forEach((domain) => {
    acc[domain] = (acc[domain] || 0) + 1;
  });
  return acc;
}, {});

const domains = Object.entries(domainMap)
  .map(([domain, count]) => ({ domain, count }))
  .sort((a, b) => b.count - a.count);
---

<BaseLayout title="Patterns - Awesome Agentic Patterns">
  <div class="patterns-page">
    <div class="patterns-header">
      <h1>Patterns</h1>
      <p class="patterns-subtitle">
        Browse our comprehensive collection of AI agent design patterns.
      </p>
      <div class="patterns-search">
        <SearchBox placeholder="Search patterns..." />
      </div>
      <button class="filters-toggle-mobile" id="filters-open" aria-label="Open filters">
        <svg
          width="20"
          height="20"
          viewBox="0 0 20 20"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M3 5H17M3 10H17M3 15H17"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"></path>
        </svg>
        Filters
      </button>
    </div>

    <div class="patterns-layout">
      <!-- Filter Sidebar -->
      <aside class="patterns-filters" id="filters">
        <div class="patterns-filters-header">
          <h2 class="patterns-filters-title">Filters</h2>
          <button class="filters-toggle" id="filters-close" aria-label="Close filters">
            <svg
              width="20"
              height="20"
              viewBox="0 0 20 20"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M4 4L16 16M4 16L16 4"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"></path>
            </svg>
          </button>
        </div>

        <div class="filter-group">
          <h3 class="filter-group-title">Category</h3>
          <div class="filter-options">
            {
              categories.map(({ category, count }) => (
                <a
                  href={`/patterns?category=${encodeURIComponent(category)}`}
                  class="filter-option"
                >
                  <span class="filter-option-label">{category}</span>
                  <span class="filter-option-count">{count}</span>
                </a>
              ))
            }
          </div>
        </div>

        <div class="filter-group">
          <h3 class="filter-group-title">Status</h3>
          <div class="filter-options">
            {
              statuses.map(({ status, count }) => (
                <a href={`/patterns?status=${status}`} class="filter-option">
                  <span class="filter-option-label">{status}</span>
                  <span class="filter-option-count">{count}</span>
                </a>
              ))
            }
          </div>
        </div>

        <div class="filter-group">
          <h3 class="filter-group-title">Maturity</h3>
          <div class="filter-options">
            {
              maturities.map(({ maturity, count }) => (
                <a href={`/patterns?maturity=${maturity}`} class="filter-option">
                  <span class="filter-option-label">{maturity}</span>
                  <span class="filter-option-count">{count}</span>
                </a>
              ))
            }
          </div>
        </div>

        <div class="filter-group">
          <h3 class="filter-group-title">Complexity</h3>
          <div class="filter-options">
            {
              complexities.map(({ complexity, count }) => (
                <a href={`/patterns?complexity=${complexity}`} class="filter-option">
                  <span class="filter-option-label">{complexity}</span>
                  <span class="filter-option-count">{count}</span>
                </a>
              ))
            }
          </div>
        </div>

        <div class="filter-group">
          <h3 class="filter-group-title">Tags</h3>
          <div class="filter-options">
            {
              tags.map(({ tag, count }) => (
                <a href={`/patterns?tag=${encodeURIComponent(tag)}`} class="filter-option">
                  <span class="filter-option-label">{tag}</span>
                  <span class="filter-option-count">{count}</span>
                </a>
              ))
            }
          </div>
        </div>

        {
          domains.length > 0 && (
            <div class="filter-group">
              <h3 class="filter-group-title">Domains</h3>
              <div class="filter-options">
                {domains.map(({ domain, count }) => (
                  <a href={`/patterns?domain=${encodeURIComponent(domain)}`} class="filter-option">
                    <span class="filter-option-label">{domain}</span>
                    <span class="filter-option-count">{count}</span>
                  </a>
                ))}
              </div>
            </div>
          )
        }

        <a href="/patterns" class="clear-filters">Clear Filters</a>
      </aside>

      <!-- Pattern Grid -->
      <div class="patterns-content">
        <div class="patterns-count" id="patterns-count">
          Showing {patterns.length} pattern{patterns.length === 1 ? '' : 's'}
        </div>

        <div class="patterns-grid" id="patterns-grid">
          {
            patterns.map((pattern: PatternEntry) => (
              <div
                class="pattern-card-wrapper"
                data-pattern-card
                data-category={pattern.category}
                data-status={pattern.status}
                data-maturity={pattern.maturity || ''}
                data-complexity={pattern.complexity || ''}
                data-tags={pattern.tags.join('|')}
                data-domains={(pattern.domains || []).join('|')}
                data-search={`${pattern.title} ${pattern.summary || ''} ${pattern.category} ${pattern.tags.join(' ')} ${(pattern.domains || []).join(' ')}`.toLowerCase()}
              >
                <PatternCard
                  title={pattern.title}
                  slug={pattern.slug}
                  summary={pattern.summary}
                  status={pattern.status}
                  category={pattern.category}
                  tags={pattern.tags}
                />
              </div>
            ))
          }
        </div>

        <div class="patterns-empty" id="patterns-empty" hidden>
          <p>No patterns found.</p>
          <a href="/patterns" class="button"> Clear Filters </a>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .patterns-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--spacing-xl) var(--spacing-lg);
  }

  .patterns-header {
    text-align: center;
    margin-bottom: var(--spacing-2xl);
  }

  .patterns-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: var(--spacing-md);
  }

  .patterns-subtitle {
    font-size: 1.125rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xl);
  }

  .patterns-search {
    max-width: 600px;
    margin: 0 auto;
  }

  .filters-toggle-mobile {
    display: none;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-xs);
    margin: var(--spacing-md) auto 0;
    padding: var(--spacing-sm) var(--spacing-lg);
    background-color: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .filters-toggle-mobile:hover {
    background-color: var(--color-primary-hover);
  }

  .patterns-layout {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: var(--spacing-xl);
    align-items: start;
  }

  .patterns-filters {
    position: sticky;
    top: 100px;
    padding: var(--spacing-lg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    background-color: var(--color-bg);
  }

  .patterns-filters-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-lg);
  }

  .filters-toggle {
    display: none;
    padding: var(--spacing-xs);
    background: none;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
  }

  .filters-toggle:hover {
    background-color: var(--color-border);
    color: var(--color-text);
  }

  .patterns-filters-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0;
  }

  .filter-group {
    margin-bottom: var(--spacing-lg);
  }

  .filter-group-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--spacing-sm);
  }

  .filter-options {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
  }

  .filter-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-sm);
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-decoration: none;
    padding: var(--spacing-xs);
    border-radius: var(--radius-sm);
    transition:
      color 0.2s ease,
      background-color 0.2s ease;
  }

  .filter-option:hover {
    color: var(--color-text);
    background-color: var(--color-border);
  }

  .filter-option-label {
    flex: 1;
  }

  .filter-option-count {
    flex-shrink: 0;
    padding: 2px 6px;
    background-color: var(--color-border);
    border-radius: 10px;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    font-weight: 500;
  }

  .clear-filters {
    display: inline-block;
    font-size: 0.875rem;
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 500;
    margin-top: var(--spacing-md);
  }

  .clear-filters:hover {
    text-decoration: underline;
  }

  .patterns-content {
    min-width: 0;
  }

  .patterns-count {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-md);
  }

  .patterns-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--spacing-lg);
  }

  .patterns-empty {
    text-align: center;
    padding: var(--spacing-2xl);
  }

  .patterns-empty p {
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-lg);
  }

  .button {
    display: inline-block;
    padding: var(--spacing-sm) var(--spacing-xl);
    background-color: var(--color-primary);
    color: white;
    text-decoration: none;
    border-radius: var(--radius-md);
    font-weight: 500;
  }

  .button:hover {
    background-color: var(--color-primary-hover);
  }

  @media (max-width: 1024px) {
    .patterns-layout {
      grid-template-columns: 1fr;
    }

    .patterns-filters {
      position: static;
    }
  }

  @media (max-width: 640px) {
    .patterns-page {
      padding: var(--spacing-md) var(--spacing-sm);
    }

    .patterns-header h1 {
      font-size: 1.75rem;
    }

    .patterns-subtitle {
      font-size: 1rem;
    }

    .filters-toggle-mobile {
      display: flex;
    }

    .patterns-filters {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      overflow-y: auto;
      border-radius: 0;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }

    .patterns-filters.open {
      transform: translateX(0);
    }

    .filters-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .patterns-grid {
      grid-template-columns: 1fr;
    }

    .filter-option {
      padding: var(--spacing-sm);
    }
  }
</style>

<script>
  const params = new URLSearchParams(window.location.search);
  const selectedCategories = params.getAll('category');
  const selectedStatuses = params.getAll('status');
  const selectedMaturities = params.getAll('maturity');
  const selectedComplexities = params.getAll('complexity');
  const selectedTags = params.getAll('tag');
  const selectedDomains = params.getAll('domain');
  const searchQuery = params.get('q')?.trim().toLowerCase() || '';

  const cards = document.querySelectorAll('[data-pattern-card]');
  let visibleCount = 0;

  cards.forEach((card) => {
    const category = card.getAttribute('data-category') || '';
    const status = card.getAttribute('data-status') || '';
    const maturity = card.getAttribute('data-maturity') || '';
    const complexity = card.getAttribute('data-complexity') || '';
    const tags = (card.getAttribute('data-tags') || '').split('|').filter(Boolean);
    const domains = (card.getAttribute('data-domains') || '').split('|').filter(Boolean);
    const search = card.getAttribute('data-search') || '';

    let matches = true;

    if (selectedCategories.length > 0 && !selectedCategories.includes(category)) {
      matches = false;
    }

    if (selectedStatuses.length > 0 && !selectedStatuses.includes(status)) {
      matches = false;
    }

    if (selectedMaturities.length > 0 && !selectedMaturities.includes(maturity)) {
      matches = false;
    }

    if (selectedComplexities.length > 0 && !selectedComplexities.includes(complexity)) {
      matches = false;
    }

    if (selectedTags.length > 0 && !tags.some((tag) => selectedTags.includes(tag))) {
      matches = false;
    }

    if (selectedDomains.length > 0 && !domains.some((domain) => selectedDomains.includes(domain))) {
      matches = false;
    }

    if (searchQuery && !search.includes(searchQuery)) {
      matches = false;
    }

    card.hidden = !matches;
    if (matches) visibleCount += 1;
  });

  const countEl = document.getElementById('patterns-count');
  if (countEl) {
    countEl.textContent = `Showing ${visibleCount} pattern${visibleCount === 1 ? '' : 's'}`;
  }

  const emptyEl = document.getElementById('patterns-empty');
  if (emptyEl) {
    emptyEl.hidden = visibleCount > 0;
  }

  // Mobile filter toggle functionality
  const filtersOpen = document.getElementById('filters-open');
  const filtersClose = document.getElementById('filters-close');
  const filtersPanel = document.getElementById('filters');

  filtersOpen?.addEventListener('click', () => {
    filtersPanel?.classList.add('open');
    document.body.style.overflow = 'hidden';
  });

  filtersClose?.addEventListener('click', () => {
    filtersPanel?.classList.remove('open');
    document.body.style.overflow = '';
  });

  // Close filters when clicking outside
  document.addEventListener('click', (e) => {
    if (
      filtersPanel?.classList.contains('open') &&
      !filtersPanel.contains(e.target as Node) &&
      !filtersOpen?.contains(e.target as Node)
    ) {
      filtersPanel?.classList.remove('open');
      document.body.style.overflow = '';
    }
  });
</script>
