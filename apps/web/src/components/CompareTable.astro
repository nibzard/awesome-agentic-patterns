---
import { renderMarkdown } from '../lib/markdown';

interface Pattern {
  id: string;
  slug: string;
  title: string;
  summary?: string;
  status: string;
  category: string;
  maturity?: string;
  complexity?: string;
  effort?: string;
  impact?: string;
  signals?: string[];
  anti_signals?: string[];
  tradeoffs?: string | null;
  tags?: string[];
  domains?: string[];
}

interface Props {
  patterns: Pattern[];
}

const { patterns } = Astro.props;

// Fields to compare
const compareFields = [
  { key: 'summary', label: 'Summary' },
  { key: 'status', label: 'Status' },
  { key: 'category', label: 'Category' },
  { key: 'maturity', label: 'Maturity' },
  { key: 'complexity', label: 'Complexity' },
  { key: 'effort', label: 'Effort' },
  { key: 'impact', label: 'Impact' },
  { key: 'signals', label: 'Signals' },
  { key: 'anti_signals', label: 'Anti-signals' },
  { key: 'tradeoffs', label: 'Trade-offs' },
  { key: 'tags', label: 'Tags' },
  { key: 'domains', label: 'Domains' },
];

const formatValue = (value: string | string[] | undefined): string => {
  if (!value) return '—';
  if (Array.isArray(value)) {
    return value.slice(0, 3).join(', ') + (value.length > 3 ? '...' : '');
  }
  if (value.trim().length === 0) return '—';
  return value
    .split('-')
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
};
---

{
  patterns.length > 0 ? (
    <div class="compare-table-wrapper">
      <table class="compare-table">
        <thead>
          <tr>
            <th class="compare-table-row-label">Field</th>
            {patterns.map((pattern) => (
              <th class="compare-table-header">
                <a href={`/patterns/${pattern.slug}`} class="compare-table-title">
                  {pattern.title}
                </a>
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {compareFields.map((field) => (
            <tr
              class:list={[
                'compare-table-row',
                { 'compare-table-row--alt': compareFields.indexOf(field) % 2 === 0 },
              ]}
            >
              <td class="compare-table-row-label">{field.label}</td>
              {patterns.map((pattern) => (
                <td class="compare-table-cell">
                  {field.key === 'summary' ? (
                    <span>{pattern.summary || '—'}</span>
                  ) : field.key === 'tradeoffs' ? (
                    pattern.tradeoffs ? (
                      <div
                        class="compare-table-tradeoffs"
                        set:html={renderMarkdown(pattern.tradeoffs.trim())}
                      />
                    ) : (
                      <span>—</span>
                    )
                  ) : field.key === 'tags' ||
                    field.key === 'domains' ||
                    field.key === 'signals' ||
                    field.key === 'anti_signals' ? (
                    ((pattern[field.key as keyof Pattern] as string[] | undefined) || []).length >
                    0 ? (
                      <div class="compare-table-tags">
                        {(pattern[field.key as keyof Pattern] as string[])
                          ?.slice(0, 3)
                          .map((item: string) => (
                            <span class="compare-table-tag">{item}</span>
                          ))}
                        {(pattern[field.key as keyof Pattern] as string[])?.length > 3 && (
                          <span class="compare-table-more">
                            +{(pattern[field.key as keyof Pattern] as string[]).length - 3}
                          </span>
                        )}
                      </div>
                    ) : (
                      <span>—</span>
                    )
                  ) : (
                    <span>
                      {formatValue(pattern[field.key as keyof Pattern] as string | string[])}
                    </span>
                  )}
                </td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  ) : (
    <div class="compare-table-empty">
      <p>No patterns selected for comparison.</p>
      <a href="/patterns" class="button">
        Browse Patterns
      </a>
    </div>
  )
}

<style>
  .compare-table-wrapper {
    overflow-x: auto;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
  }

  .compare-table-wrapper::-webkit-scrollbar {
    height: 8px;
  }

  .compare-table-wrapper::-webkit-scrollbar-track {
    background: var(--color-border);
    border-radius: 4px;
  }

  .compare-table-wrapper::-webkit-scrollbar-thumb {
    background: var(--color-text-muted);
    border-radius: 4px;
  }

  .compare-table-wrapper::-webkit-scrollbar-thumb:hover {
    background: var(--color-text);
  }

  .compare-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
  }

  .compare-table th,
  .compare-table td {
    padding: var(--spacing-md);
    text-align: left;
    border-bottom: 1px solid var(--color-divider);
  }

  .compare-table-header {
    background-color: var(--color-border);
    font-weight: 600;
    min-width: 200px;
  }

  .compare-table-title {
    color: var(--color-text);
    text-decoration: none;
    font-size: 1rem;
    display: block;
  }

  .compare-table-title:hover {
    color: var(--color-primary);
  }

  .compare-table-row-label {
    font-weight: 500;
    color: var(--color-text-muted);
    background-color: var(--color-bg);
    position: sticky;
    left: 0;
  }

  .compare-table-row--alt .compare-table-row-label {
    background-color: var(--color-bg);
  }

  .compare-table-cell {
    font-size: 0.875rem;
    color: var(--color-text);
    min-width: 150px;
  }

  .compare-table-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
  }

  .compare-table-tag {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    background-color: var(--color-border);
    padding: 2px 8px;
    border-radius: var(--radius-sm);
  }

  .compare-table-more {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .compare-table-tradeoffs {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    line-height: 1.5;
  }

  .compare-table-tradeoffs :global(ul) {
    margin: 0;
    padding-left: var(--spacing-md);
  }

  .compare-table-tradeoffs :global(li) {
    margin-bottom: var(--spacing-xs);
  }

  .compare-table-empty {
    text-align: center;
    padding: var(--spacing-2xl);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
  }

  .compare-table-empty p {
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-lg);
  }

  .button {
    display: inline-block;
    padding: var(--spacing-sm) var(--spacing-xl);
    background-color: var(--color-primary);
    color: white;
    text-decoration: none;
    border-radius: var(--radius-md);
    font-weight: 500;
    transition: background-color 0.2s ease;
  }

  .button:hover {
    background-color: var(--color-primary-hover);
  }
</style>
