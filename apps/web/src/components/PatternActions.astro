---
import CopyButton from './CopyButton.astro';

interface Props {
  pattern: {
    title: string;
    slug: string;
    summary?: string;
    status: string;
    category?: string;
    complexity?: string;
    maturity?: string;
    effort?: string;
    impact?: string;
    authors: string[];
    tags: string[];
    source?: string;
    body: string;
    updated_at?: string;
  };
}

const { pattern } = Astro.props;

const SITE_URL = 'https://agentic-patterns.com';

function formatAuthors(authors: string[]): string {
  if (authors.length === 0) return 'Awesome Agentic Patterns';
  if (authors.length === 1) return authors[0];
  if (authors.length === 2) return `${authors[0]} & ${authors[1]}`;
  return `${authors.slice(0, -1).join(', ')}, & ${authors[authors.length - 1]}`;
}

function formatBibtexAuthors(authors: string[]): string {
  if (authors.length === 0) return 'Awesome Agentic Patterns';
  return authors.join(' and ');
}

function getCitationYear(updatedAt?: string): string {
  if (!updatedAt) return String(new Date().getFullYear());
  const match = updatedAt.match(/^\d{4}/);
  return match ? match[0] : String(new Date().getFullYear());
}

const citationYear = getCitationYear(pattern.updated_at);
const retrievalDate = new Date().toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
const citationUrl = `${SITE_URL}/patterns/${pattern.slug}`;
const authors = formatAuthors(pattern.authors);
const bibtexAuthors = formatBibtexAuthors(pattern.authors);

const apaCitation = `${authors} (${citationYear}). ${pattern.title}. In *Awesome Agentic Patterns*. Retrieved ${retrievalDate}, from ${citationUrl}`;
const bibtexCitation = `@misc{agentic_patterns_${pattern.slug},
  title = {${pattern.title}},
  author = {${bibtexAuthors}},
  year = {${citationYear}},
  howpublished = {\\url{${citationUrl}}},
  note = {Awesome Agentic Patterns}
}`;

// Convert pattern to markdown format
function toMarkdown(pattern: Props['pattern']): string {
  let md = `# ${pattern.title}\n\n`;

  if (pattern.summary) {
    md += `${pattern.summary}\n\n`;
  }

  md += `**Status:** ${pattern.status}\n`;

  if (pattern.category) {
    md += `**Category:** ${pattern.category}\n`;
  }

  if (pattern.complexity) {
    md += `**Complexity:** ${pattern.complexity}\n`;
  }

  if (pattern.maturity) {
    md += `**Maturity:** ${pattern.maturity}\n`;
  }

  if (pattern.effort) {
    md += `**Effort:** ${pattern.effort}\n`;
  }

  if (pattern.impact) {
    md += `**Impact:** ${pattern.impact}\n`;
  }

  if (pattern.authors.length > 0) {
    md += `**Authors:** ${pattern.authors.join(', ')}\n`;
  }

  if (pattern.tags.length > 0) {
    md += `**Tags:** ${pattern.tags.join(', ')}\n`;
  }

  if (pattern.source) {
    md += `**Source:** ${pattern.source}\n`;
  }

  if (pattern.updated_at) {
    md += `**Updated:** ${pattern.updated_at}\n`;
  }

  md += `\n${pattern.body}`;

  return md;
}

const markdownContent = toMarkdown(pattern);
const jsonContent = JSON.stringify(pattern, null, 2);
---

<div class="pattern-actions">
  <button
    class="action-button"
    data-copy="markdown"
    data-content={markdownContent}
    aria-label="Copy as Markdown"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
      <polyline points="14 2 14 8 20 8"></polyline>
      <line x1="16" y1="13" x2="8" y2="13"></line>
      <line x1="16" y1="17" x2="8" y2="17"></line>
      <polyline points="10 9 9 9 8 9"></polyline>
    </svg>
    Copy as Markdown
  </button>

  <button
    class="action-button"
    data-copy="json"
    data-content={jsonContent}
    aria-label="Copy as JSON"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <polyline points="16 18 22 12 16 6"></polyline>
      <polyline points="8 6 2 12 8 18"></polyline>
    </svg>
    Copy as JSON
  </button>

  <details
    class="pack-details"
    data-pack-action
    data-pattern-slug={pattern.slug}
    data-pattern-title={pattern.title}
  >
    <summary class="action-button" aria-label="Add this pattern to a pack">Add to Pack</summary>
    <div class="pack-panel">
      <div class="pack-row">
        <label class="pack-label" for={`pack-select-${pattern.slug}`}>Choose pack</label>
        <select class="pack-select" id={`pack-select-${pattern.slug}`} aria-label="Select a pack">
          <option value="">No packs yet</option>
        </select>
        <button class="pack-add" type="button" data-pack-add>Add</button>
      </div>
      <div class="pack-divider">or</div>
      <div class="pack-row">
        <label class="pack-label" for={`pack-new-${pattern.slug}`}>New pack</label>
        <input
          class="pack-input"
          id={`pack-new-${pattern.slug}`}
          type="text"
          placeholder="Name your pack"
        />
        <button class="pack-create" type="button" data-pack-create>Create</button>
      </div>
      <p class="pack-hint">
        Saved locally in this browser. Manage and export packs on the Packs page.
      </p>
      <span class="pack-feedback" aria-live="polite"></span>
    </div>
  </details>

  <details class="citation-details">
    <summary class="action-button" aria-label="Cite this pattern">Cite This Pattern</summary>
    <div class="citation-panel">
      <div class="citation-row">
        <div class="citation-header">
          <span class="citation-label">APA</span>
          <CopyButton content={apaCitation} label="Copy APA citation" />
        </div>
        <pre class="citation-text">{apaCitation}</pre>
      </div>
      <div class="citation-row">
        <div class="citation-header">
          <span class="citation-label">BibTeX</span>
          <CopyButton content={bibtexCitation} label="Copy BibTeX citation" />
        </div>
        <pre class="citation-text citation-text--code">{bibtexCitation}</pre>
      </div>
    </div>
  </details>

  <span class="copy-feedback" aria-live="polite"></span>
</div>

<script>
  const buttons = document.querySelectorAll('[data-copy]');
  const feedback = document.querySelector('.copy-feedback');
  const packContainer = document.querySelector('[data-pack-action]');
  const storageKey = 'aap:user-packs';

  buttons.forEach((button) => {
    button.addEventListener('click', async () => {
      const content = button.getAttribute('data-content');
      const format = button.getAttribute('data-copy');

      if (!content) return;

      try {
        await navigator.clipboard.writeText(content);
        feedback!.textContent = `Copied as ${format}!`;
        setTimeout(() => {
          feedback!.textContent = '';
        }, 2000);
      } catch (err) {
        feedback!.textContent = 'Failed to copy';
        setTimeout(() => {
          feedback!.textContent = '';
        }, 2000);
      }
    });
  });

  const loadPacks = () => {
    try {
      const stored = localStorage.getItem(storageKey);
      const parsed = stored ? JSON.parse(stored) : [];
      if (!Array.isArray(parsed)) return [];
      return parsed.map((pack) => ({
        ...pack,
        patterns: Array.isArray(pack.patterns) ? pack.patterns : [],
      }));
    } catch (error) {
      return [];
    }
  };

  const savePacks = (packs) => {
    try {
      localStorage.setItem(storageKey, JSON.stringify(packs));
    } catch (error) {
      showPackFeedback('Unable to save packs in this browser.', true);
    }
  };

  const showPackFeedback = (message, isError = false) => {
    if (!packContainer) return;
    const feedbackEl = packContainer.querySelector('.pack-feedback');
    if (!feedbackEl) return;
    feedbackEl.textContent = message;
    feedbackEl.classList.toggle('pack-feedback--error', isError);
    setTimeout(() => {
      feedbackEl.textContent = '';
      feedbackEl.classList.remove('pack-feedback--error');
    }, 2400);
  };

  const renderPackSelect = (selectEl, addButton, packs) => {
    if (!selectEl) return;
    selectEl.innerHTML = '';
    if (packs.length === 0) {
      const option = document.createElement('option');
      option.value = '';
      option.textContent = 'No packs yet';
      selectEl.appendChild(option);
      selectEl.disabled = true;
      if (addButton) addButton.disabled = true;
      return;
    }
    selectEl.disabled = false;
    if (addButton) addButton.disabled = false;
    packs.forEach((pack) => {
      const option = document.createElement('option');
      option.value = pack.id;
      option.textContent = `${pack.name} (${pack.patterns.length})`;
      selectEl.appendChild(option);
    });
  };

  const createPackId = () =>
    `pack-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 7)}`;

  const addPatternToPack = (packs, packId, slug) => {
    const pack = packs.find((item) => item.id === packId);
    if (!pack) return { packs, status: 'missing' };
    if (!pack.patterns.includes(slug)) {
      pack.patterns.push(slug);
      pack.updatedAt = new Date().toISOString();
      return { packs, status: 'added', pack };
    }
    return { packs, status: 'exists', pack };
  };

  if (packContainer) {
    const slug = packContainer.getAttribute('data-pattern-slug') || '';
    const selectEl = packContainer.querySelector('.pack-select');
    const addButton = packContainer.querySelector('[data-pack-add]');
    const createButton = packContainer.querySelector('[data-pack-create]');
    const createInput = packContainer.querySelector('.pack-input');

    const packs = loadPacks();
    renderPackSelect(selectEl, addButton, packs);

    addButton?.addEventListener('click', () => {
      const selectedId = selectEl?.value;
      if (!selectedId) {
        showPackFeedback('Create a pack first.', true);
        return;
      }
      const nextPacks = loadPacks();
      const result = addPatternToPack(nextPacks, selectedId, slug);
      if (result.status === 'missing') {
        showPackFeedback('Pack not found.', true);
        return;
      }
      if (result.status === 'exists') {
        showPackFeedback('Already in that pack.');
        return;
      }
      savePacks(result.packs);
      renderPackSelect(selectEl, addButton, result.packs);
      showPackFeedback(`Added to ${result.pack.name}.`);
    });

    createButton?.addEventListener('click', () => {
      const name = createInput?.value.trim();
      if (!name) {
        showPackFeedback('Add a pack name.', true);
        return;
      }
      const nextPacks = loadPacks();
      const newPack = {
        id: createPackId(),
        name,
        patterns: slug ? [slug] : [],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
      };
      nextPacks.unshift(newPack);
      savePacks(nextPacks);
      renderPackSelect(selectEl, addButton, nextPacks);
      if (selectEl) selectEl.value = newPack.id;
      if (createInput) createInput.value = '';
      showPackFeedback(`Created "${name}".`);
    });
  }
</script>

<style>
  .pattern-actions {
    display: flex;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
    margin-bottom: var(--spacing-lg);
  }

  .action-button {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm) var(--spacing-md);
    background-color: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .action-button:hover {
    background-color: var(--color-border);
    border-color: var(--color-text-muted);
  }

  .action-button:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .action-button svg {
    flex-shrink: 0;
  }

  .pack-details {
    flex-basis: 100%;
  }

  .pack-details summary {
    list-style: none;
  }

  .pack-details summary::-webkit-details-marker {
    display: none;
  }

  .pack-panel {
    margin-top: var(--spacing-sm);
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background-color: var(--color-bg);
    display: grid;
    gap: var(--spacing-sm);
  }

  .pack-row {
    display: grid;
    grid-template-columns: minmax(120px, 1fr) 1.5fr auto;
    gap: var(--spacing-sm);
    align-items: center;
  }

  .pack-label {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    font-weight: 500;
  }

  .pack-select,
  .pack-input {
    width: 100%;
    padding: var(--spacing-xs) var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background-color: var(--color-bg);
    color: var(--color-text);
    font-size: 0.875rem;
  }

  .pack-add,
  .pack-create {
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--radius-sm);
    border: 1px solid var(--color-border);
    background-color: var(--color-primary);
    color: white;
    font-size: 0.8125rem;
    font-weight: 500;
    cursor: pointer;
  }

  .pack-add:hover,
  .pack-create:hover {
    background-color: var(--color-primary-hover);
  }

  .pack-add:disabled,
  .pack-create:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  .pack-divider {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-muted);
    text-align: center;
  }

  .pack-hint {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  .pack-feedback {
    font-size: 0.8125rem;
    color: var(--color-success);
  }

  .pack-feedback--error {
    color: var(--color-error);
  }

  .citation-details {
    flex-basis: 100%;
  }

  .citation-details summary {
    list-style: none;
  }

  .citation-details summary::-webkit-details-marker {
    display: none;
  }

  .citation-panel {
    margin-top: var(--spacing-sm);
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background-color: var(--color-bg);
    display: grid;
    gap: var(--spacing-md);
  }

  .citation-row {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .citation-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-sm);
  }

  .citation-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
  }

  .citation-text {
    margin: 0;
    padding: var(--spacing-sm);
    background-color: var(--color-border);
    border-radius: var(--radius-sm);
    font-size: 0.8125rem;
    color: var(--color-text);
    white-space: pre-wrap;
    word-break: break-word;
  }

  .citation-text--code {
    font-family: var(--font-mono);
  }

  .copy-feedback {
    font-size: 0.875rem;
    color: var(--color-success);
    margin-left: var(--spacing-sm);
  }

  @media (max-width: 640px) {
    .pattern-actions {
      flex-direction: column;
    }

    .action-button {
      width: 100%;
      justify-content: center;
    }

    .pack-row {
      grid-template-columns: 1fr;
      align-items: stretch;
    }

    .pack-add,
    .pack-create {
      width: 100%;
    }
  }
</style>
